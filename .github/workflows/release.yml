name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.1.0)'
        required: true

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false

  build-tauri:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: self-hosted
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Kill Node processes
        if: runner.os == 'Windows'
        run: taskkill /F /IM node.exe
        continue-on-error: true

      - name: Install frontend dependencies
        working-directory: flemme-app
        run: npm install

      - name: Read signing key
        id: read_key
        shell: powershell
        run: |
          $key = Get-Content "C:/Users/aymer/.tauri/flemme.key" -Raw
          "SIGNING_KEY=$key" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Build and Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ steps.read_key.outputs.SIGNING_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: flemme_secure_password_2024
        with:
          projectPath: flemme-app
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

      - name: Get version
        id: get_version
        shell: powershell
        run: |
          $version = if ($env:GITHUB_EVENT_NAME -eq "workflow_dispatch") {
            "${{ github.event.inputs.version }}"
          } else {
            "${{ github.ref }}" -replace 'refs/tags/', ''
          }
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Generate and upload latest.json
        shell: powershell
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $versionNoV = $version -replace '^v', ''
          $pubDate = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

          # Find the signature file
          $sigPath = Get-ChildItem -Path "flemme-app/src-tauri/target/release/bundle" -Filter "*.msi.zip.sig" -Recurse | Select-Object -First 1
          
          if (-not $sigPath) {
            Write-Error "Signature file not found! Ensure the build produced an .msi.zip.sig file."
            exit 1
          }
          
          $signature = Get-Content $sigPath.FullName
          Write-Host "Found signature: $signature"

          # Create JSON manually in the exact format Tauri expects
          $json = "{`n"
          $json += "  `"version`": `"$versionNoV`",`n"
          $json += "  `"notes`": `"Nouvelle version disponible`",`n"
          $json += "  `"pub_date`": `"$pubDate`",`n"
          $json += "  `"platforms`": {`n"
          $json += "    `"windows-x86_64`": {`n"
          $json += "      `"signature`": `"$signature`",`n"
          $json += "      `"url`": `"https://github.com/ay-bell/Flemme/releases/download/$version/flemme-app_${versionNoV}_x64_en-US.msi.zip`"`n"
          $json += "    }`n"
          $json += "  }`n"
          $json += "}`n"

          # Write without BOM
          [System.IO.File]::WriteAllText("$PWD/latest.json", $json, [System.Text.UTF8Encoding]::new($false))
          Write-Host "Generated latest.json:"
          Get-Content latest.json

          # Upload using GitHub API
          $headers = @{
            "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
            "Accept" = "application/vnd.github.v3+json"
          }

          # Get release info
          $releaseUrl = "https://api.github.com/repos/ay-bell/Flemme/releases/tags/$version"
          $release = Invoke-RestMethod -Uri $releaseUrl -Headers $headers -Method Get

          # Check if latest.json already exists and delete it
          $existingAsset = $release.assets | Where-Object { $_.name -eq "latest.json" }
          if ($existingAsset) {
            Write-Host "Deleting existing latest.json..."
            Invoke-RestMethod -Uri $existingAsset.url -Headers $headers -Method Delete
          }

          # Upload new latest.json
          $uploadUrl = $release.upload_url -replace '\{\?name,label\}', "?name=latest.json"
          $fileBytes = [System.IO.File]::ReadAllBytes("$PWD/latest.json")

          $uploadHeaders = @{
            "Authorization" = "token ${{ secrets.GITHUB_TOKEN }}"
            "Content-Type" = "application/json"
          }

          Write-Host "Uploading latest.json to $uploadUrl"
          Invoke-RestMethod -Uri $uploadUrl -Headers $uploadHeaders -Method Post -Body $fileBytes
          Write-Host "Successfully uploaded latest.json"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
